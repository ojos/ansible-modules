---
- name: Create terraform aws directory.
  file: >
    path="{{ terraform_aws_directory }}"
    state=directory
    mode=0755

- name: Create terraform aws environment directory.
  file: >
    path="{{ terraform_aws_directory }}/{{ item }}"
    state=directory
    mode=0755
  with_items: "{{ terraform_aws_environments }}"
  when: terraform_aws_environments|length > 0

- name: Copy config.tf.
  copy: >
    src=config.tf
    dest={{ terraform_aws_directory }}/{{ item }}/config.tf
    mode=0644
  with_items: "{{ terraform_aws_environments }}"
  when: terraform_aws_environments|length > 0
- name: Replace environment in config.tf.
  replace: >
    dest={{ terraform_aws_directory }}/{{ item }}/config.tf
    replace="\1\"{{ item }}\""
    regexp='^(\s+default\s=\s)".+"'
  with_items: "{{ terraform_aws_environments }}"
  when: terraform_aws_environments|length > 0

- name: Copy template files.
  copy: >
    src="{{ item.1 }}.tf"
    dest="{{ terraform_aws_directory }}/{{ item.0.environment }}/{{ item.1 }}.tf"
    mode=0644
  when: item.0.environment in terraform_aws_environments
  with_subelements:
    - terraform_aws_environment_templates
    - providers

- name: Insert env in .envrc.
  lineinfile: >
    dest={{ terraform_aws_envrc_directory }}/.envrc
    line="{{ item.value }}"
    insertafter=EOF
    state=present
    regexp={{ item.regexp }}
  with_items: "{{ terraform_aws_environment_variables }}"
  when: terraform_aws_envrc_directory != '' and terraform_aws_environment_variables|length > 0
